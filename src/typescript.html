<script type="text/html" data-template-name="typescript">
    <style>
        .func-tabs-row {
            margin-bottom: 0;
        }
        #node-input-libs-container-row .red-ui-editableList-container {
            padding: 0px;
        }
        #node-input-libs-container-row .red-ui-editableList-container li {
            padding:0px;
        }
        #node-input-libs-container-row .red-ui-editableList-item-remove {
            right: 5px;
        }

        #node-input-libs-container-row .red-ui-editableList-header {
            display: flex;
            background: var(--red-ui-tertiary-background);
            padding-right: 75px;
            border-top-left-radius: 3px;
            border-top-right-radius: 3px;
        }
        #node-input-libs-container-row .red-ui-editableList-header > div {
            flex-grow: 1;
        }

        .node-libs-entry {
            display: flex;
        }

        .node-libs-entry .red-ui-typedInput-container {
            border-radius: 0;
            border: none;
        }
        .node-libs-entry .red-ui-typedInput-type-select {
            border-radius: 0 !important;
            height: 34px;
        }
        .node-libs-entry > span > input[type=text] {
            border-radius: 0;
            border-top-color: var(--red-ui-form-background);
            border-bottom-color: var(--red-ui-form-background);
            border-right-color: var(--red-ui-form-background);
        }
        .node-libs-entry > span > input[type=text].input-error {
        }
        .node-libs-entry > span {
            flex-grow: 1;
            width: 50%;
            position: relative;
        }
        .node-libs-entry span .node-input-libs-var, .node-libs-entry span .red-ui-typedInput-container {
            width: 100%;
        }
        .node-libs-entry > span > span > i {
            display: none;
        }
        .node-libs-entry > span > span.input-error > i {
            display: inline;
        }

    </style>
    <input type="hidden" id="node-input-func">
    <input type="hidden" id="node-input-noerr">
    <input type="hidden" id="node-input-finalize">
    <input type="hidden" id="node-input-initialize">
    <input type="hidden" id="node-input-updated">
    <input type="hidden" id="node-input-declare">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <div style="display: inline-block; width: calc(100% - 105px)"><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div>
    </div>


    <div class="form-row func-tabs-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="func-tabs"></ul>
    </div>
    <div id="func-tabs-content" style="min-height: calc(100% - 95px);">

        <div id="func-tab-config" style="display:none">
            <div>
                <div class="form-row" style="display: inline-block; margin-right: 50px;">
                    <label for="node-input-outputs"><i class="fa fa-random"></i> <span data-i18n="node-red:function.label.outputs"></span></label>
                    <input id="node-input-outputs" style="width: 60px;" value="1">
                </div>
                <div class="form-row" style="display: inline-block;">
                    <label for="node-input-timeout" style="width: 140px;"><i class="fa fa-clock-o"></i> <span data-i18n="node-red:function.label.timeout"></span></label>
                    <input id="node-input-timeout" style="width: 60px;" data-i18n="[placeholder]join.seconds">
                </div>
            </div>

            <div class="form-row">
                <label><i class="fa fa-cog"></i> Execution</label>
                <input type="checkbox" id="node-input-useVm" style="display:inline-block; width:auto; vertical-align:top;" title="Use VM instead of Function constructor (slower but more secure)">
                <label for="node-input-useVm" style="width:70%;" title="Use VM instead of Function constructor (slower but more secure)">Use VM mode (slower but more secure)</label>
            </div>

            <div class="form-row node-input-libs-row hide node-text-editor-row" style="position:relative; margin-top: 10px;">
                <label for="node-input-declare" style="width: 200px;"><i class="fa fa-code"></i> Type Declarations</label>
                <div style="height: 100px; min-height:80px;" class="node-text-editor" id="node-input-declare-editor"></div>
                <div style="position: absolute; right:0; bottom: calc(100% - 20px); z-Index: 10;"><button type="button" id="node-declare-expand-js" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button></div>
            </div>
            
            <div class="form-row node-input-libs-row hide" style="margin-bottom: 0px;">
                <label><i class="fa fa-cubes"></i> <span data-i18n="node-red:function.label.modules"></span></label>
            </div>
            <div class="form-row node-input-libs-row hide" id="node-input-libs-container-row" style="position: relative;">
                <ol id="node-input-libs-container"></ol>
                <button type="button" id="node-add-default-modules" class="red-ui-button red-ui-button-small" style="position: absolute; right: 0; bottom: 0;" title="Add default modules">
                    <i class="fa fa-cubes"></i><span> Add Defaults</span>
                </button>
            </div>
        </div>

        <div id="func-tab-init" style="display:none">
            <div class="form-row node-text-editor-row" style="position:relative">
                <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-init-editor" ></div>
                <div style="position: absolute; right:0; bottom: calc(100% - 20px); z-Index: 10;"><button type="button" id="node-init-expand-js" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button></div>
            </div>
        </div>

        <div id="func-tab-body" style="display:none">
            <div class="form-row node-text-editor-row" style="position:relative">
                <div style="height: 220px; min-height:150px;" class="node-text-editor" id="node-input-func-editor" ></div>
                <div style="position: absolute; right:0; bottom: calc(100% - 20px); z-Index: 10;"><button type="button" id="node-function-expand-js" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button></div>
            </div>
        </div>

        <div id="func-tab-finalize" style="display:none">
            <div class="form-row node-text-editor-row" style="position:relative">
                <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-finalize-editor" ></div>
                <div style="position: absolute; right:0; bottom: calc(100% - 20px); z-Index: 10;"><button type="button" id="node-finalize-expand-js" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button></div>
            </div>
        </div>

    </div>
</script>

<script type="text/javascript">

(function() {

    function tr(key, params) {
        var result = RED._("node-red:" + key);
        if (params) {
            for (var k in params) {
                result = result.replace('{' + k + '}', params[k]);
            }
        }
        return result;
    }

    function getLabel() {
        if (this.name) return this.name;
        
        let script = this.func || '';
        for (const [key, label] of Object.entries({
            'fetch(': 'üåê Fetch',
            'fs.': 'üìÅ File',
            'crypto.': 'üîê Crypto',
            'setTimeout': '‚è∞ Timer',
            'setInterval': 'üîÑ Loop',
            'process.': '‚öôÔ∏è Process',
            'JSON.': 'üìÑ JSON',
            'Buffer': 'üî¢ Buffer'
        })) {
            if (script.includes(key)) return label;
        }

        // Extract keywords, limit to 20 chars
        const e = { const: 1, let: 1, var: 1, msg: 1, payload: 1, as: 1, any: 1, string: 1, number: 1, return: 1, null: 1 };
        let s = '';
        const ws = script.toLowerCase().match(/\w\w+/g) || [];
        for (let w of ws) {
            if (!e[w]) {
                e[w] = 1;
                const n = s ? s + ' ' + w : w;
                if (n.length <= 20) s = n;
                else break;
            }
        }
        if (s) return s;
        
        return "typescript";
    }

    function throwRequired(msg) {
        throw new Error(msg + ' is required');
    }

    function configMonaco(editor, customDeclare) {
        console.log('[TS] Config Monaco', editor);

        const monaco = window.monaco || throwRequired('monaco');
        const languages = monaco.languages || throwRequired('languages');
        const tsLanguage = languages.typescript || throwRequired('tsLanguage');
        const tsEditor = editor || throwRequired('tsEditor');
        const tsConfig = tsLanguage.typescriptDefaults || throwRequired('typescriptDefaults');
        
        // Get custom declarations or use default
        const declare = customDeclare || `declare const msg: {
    payload: any;
    [prop: string]: any;
};`;

        // Always update types to reflect current declarations
        console.log('[TS] Updating TypeScript types with declarations:', declare);

        // Add Node-RED global types
        const nodeRedTypes = `/// <reference lib="es2022" />
declare const node: {
    log: (message: string) => void;
    warn: (message: string) => void;
    error: (error: string | Error, message?: any) => void;
    context: () => {
        get: (key: string, store?: string) => any;
        set: (key: string, value: any, store?: string) => void;
        flow: any;
        global: any;
    };
    send: (msg: any | any[]) => void;
    id: string;
    type: string;
    name?: string;
};
declare const RED: {
    util: {
        getSetting: (node: any, key: string) => any;
    };
};
declare const context: {
    get: (key: string, store?: string) => any;
    set: (key: string, value: any, store?: string) => void;
    flow: any;
    global: any;
};
declare const flow: {
    get: <T = any>(key: string) => T;
    set: (key: string, value: any) => void;
};
declare const global: any;
declare const env: {
    get: (key: string) => any;
};
declare const fs: typeof import('fs/promises');
declare const path: typeof import('path');
declare const os: typeof import('os');
declare const crypto: typeof import('crypto');
declare const util: typeof import('util');
declare const process: typeof import('process');
declare const Buffer: typeof globalThis.Buffer;
declare const fetch: typeof globalThis.fetch;
declare const require: typeof globalThis.require;

${declare}`;
        
        // Update or add the extra lib
        tsConfig.addExtraLib(nodeRedTypes, 'file:///node-red-types.d.ts');

        // Only configure once per session
        if (!window.tsConfigured) {
            tsConfig.setDiagnosticsOptions({
                noSemanticValidation: false,
                noSyntaxValidation: false,
                noSuggestionDiagnostics: false,
                diagnosticCodesToIgnore: [
                    2451, // Cannot redeclare block-scoped variable 'msg'.
                    1375, // 'await' expressions are only allowed at the top level of a file when that file is a module
                    1378, // Top-level 'await' expressions are only allowed when the 'module' option is set to 'es2022'
                    1108  // A 'return' statement can only be used within a function body
                    // Removed 2339 to allow property errors to show
                ]
            });
            
            tsConfig.setCompilerOptions({
                target: tsLanguage.ScriptTarget.ES2022,
                module: tsLanguage.ModuleKind.ES2022,
                allowJs: true,
                lib: ['ES2022', 'DOM'],
                skipLibCheck: false,
                noImplicitAny: true,
                strict: true,
                strictNullChecks: true,
                strictPropertyInitialization: true,
                noImplicitReturns: true,
                noImplicitThis: true
            });
            
            console.log('[TS] TypeScript configured globally');
            window.tsConfigured = true;
        }

        // Configure individual editor model
        const tsModel = tsEditor.getModel();
        if (tsModel) {
            console.log('[TS] Current model URI:', tsModel.uri.path, 'Language:', tsModel.getLanguageId());
            
            if (!tsModel.uri.path.endsWith('.ts') || tsModel.getLanguageId() !== 'typescript') {
                console.log('[TS] Converting model to TypeScript');
                
                // Generate unique URI for this editor
                const uniqueId = tsEditor.getId ? tsEditor.getId() : Math.random().toString(36).substr(2, 9);
                const tsUri = monaco.Uri.parse(`file:///ts-${uniqueId}.ts`);
                
                // Check if model already exists with this URI
                let existingModel = monaco.editor.getModel(tsUri);
                if (existingModel) {
                    console.log('[TS] Using existing TypeScript model');
                    tsEditor.setModel(existingModel);
                } else {
                    console.log('[TS] Creating new TypeScript model');
                    const newModel = monaco.editor.createModel(
                        tsModel.getValue(),
                        'typescript',
                        tsUri
                    );
                    tsEditor.setModel(newModel);
                }
            } else {
                console.log('[TS] Model is already TypeScript');
                // Force language to typescript if not already set
                if (tsModel.getLanguageId() !== 'typescript') {
                    monaco.editor.setModelLanguage(tsModel, 'typescript');
                    console.log('[TS] Language set to TypeScript');
                }
            }
        }
    }

    function configEditor(options) {
        options.mode = "ace/mode/typescript";
        options.language = "typescript";
        
        return options;
    }

    function setEditor(editor) {

        // Configure Monaco TypeScript editor
        var session = editor.getSession();
        
        if (editor.type === "monaco") {
            // Wait for editor to be ready, then configure
            setTimeout(() => {
                try {
                    // Get current declarations from the editor (need to find the node instance)
                    let customDeclare = null;
                    if (window.currentNodeInstance && window.currentNodeInstance.declareEditor) {
                        customDeclare = window.currentNodeInstance.declareEditor.getValue();
                    }
                    configMonaco(editor, customDeclare);
                    
                    // Verify TypeScript is working after configuration
                    setTimeout(() => {
                        const model = editor.getModel();
                        if (model) {
                            console.log('[TS] Final verification - Language:', model.getLanguageId(), 'URI:', model.uri.path);
                            
                            // Force a diagnostic check by adding some temporary content
                            const originalValue = model.getValue();
                            model.setValue(originalValue + '\n// TypeScript check');
                            setTimeout(() => {
                                model.setValue(originalValue);
                            }, 100);
                        }
                    }, 500);
                }
                catch (error) {
                    console.error('[TS] Config Monaco Error', error);
                }
            }, 100);
        } else {
            console.log('[TS] Using ACE Editor fallback configuration');
            if (session.setAnnotations) {
                session.setAnnotations([]);
            }
        }
        
        console.log('[TS] TypeScript editor configuration completed');
        
        // Configure completion for available globals
        if (editor.completers) {
            editor.completers.push({
                getCompletions: function(editor, session, pos, prefix, callback) {
                    var completions = [
                        // Node-RED context
                        {name: "msg", value: "msg", score: 1000, meta: "node-red"},
                        {name: "node", value: "node", score: 1000, meta: "node-red"},
                        {name: "RED", value: "RED", score: 1000, meta: "node-red"},
                        {name: "global", value: "global", score: 1000, meta: "node-red"},
                        {name: "env", value: "env", score: 1000, meta: "node-red"},
                        
                        // Node.js modules
                        {name: "fs", value: "fs", score: 900, meta: "nodejs"},
                        {name: "path", value: "path", score: 900, meta: "nodejs"},
                        {name: "os", value: "os", score: 900, meta: "nodejs"},
                        {name: "crypto", value: "crypto", score: 900, meta: "nodejs"},
                        {name: "util", value: "util", score: 900, meta: "nodejs"},
                        {name: "Buffer", value: "Buffer", score: 900, meta: "nodejs"},
                        {name: "fetch", value: "fetch", score: 900, meta: "nodejs"},
                        
                        // Keywords
                        {name: "return", value: "return ", score: 800, meta: "keyword"},
                        {name: "await", value: "await ", score: 800, meta: "keyword"},
                        {name: "async", value: "async ", score: 800, meta: "keyword"}
                    ];
                    callback(null, completions);
                }
            });
        }
    }

    var invalidModuleVNames = [
        'console',
        'util',
        'Buffer',
        'Date',
        'RED',
        'node',
        '__node__',
        'context',
        'flow',
        'global',
        'env',
        'setTimeout',
        'clearTimeout',
        'setInterval',
        'clearInterval',
        'promisify'
    ]

    var knownFunctionNodes = {};
    RED.events.on("nodes:add", function(n) {
        if (n.type === "typescript") {
            knownFunctionNodes[n.id] = n;
        }
    })
    RED.events.on("nodes:remove", function(n) {
        if (n.type === "typescript") {
            delete knownFunctionNodes[n.id];
        }
    })

    var missingModules = [];
    var missingModuleReasons = {};
    RED.events.on("runtime-state", function(event) {
        if (event.error === "missing-modules") {
            missingModules = event.modules.map(function(m) { missingModuleReasons[m.module] = m.error; return m.module });
            for (var id in knownFunctionNodes) {
                if (knownFunctionNodes.hasOwnProperty(id) && knownFunctionNodes[id].libs && knownFunctionNodes[id].libs.length > 0) {
                    RED.editor.validateNode(knownFunctionNodes[id])
                }
            }
        } else if (!event.text) {
            missingModuleReasons = {};
            missingModules = [];
            for (var id in knownFunctionNodes) {
                if (knownFunctionNodes.hasOwnProperty(id) && knownFunctionNodes[id].libs && knownFunctionNodes[id].libs.length > 0) {
                    RED.editor.validateNode(knownFunctionNodes[id])
                }
            }
        }
        RED.view.redraw();
    });

    var installAllowList = ['*'];
    var installDenyList = [];

    var modulesEnabled = true;
    if (RED.settings.get('externalModules.modules.allowInstall', true) === false) {
        modulesEnabled = false;
    }
    var settingsAllowList = RED.settings.get("externalModules.modules.allowList")
    var settingsDenyList = RED.settings.get("externalModules.modules.denyList")
    if (settingsAllowList || settingsDenyList) {
        installAllowList = settingsAllowList;
        installDenyList = settingsDenyList
    }
    installAllowList = RED.utils.parseModuleList(installAllowList);
    installDenyList = RED.utils.parseModuleList(installDenyList);


    // object that maps from library name to its descriptor
    var allLibs = [];

    function getAllUsedModules() {
        var moduleSet = new Set();
        for (var id in knownFunctionNodes) {
            if (knownFunctionNodes.hasOwnProperty(id)) {
                if (knownFunctionNodes[id].libs) {
                    for (var i=0, l=knownFunctionNodes[id].libs.length; i<l; i++) {
                        if (RED.utils.checkModuleAllowed(knownFunctionNodes[id].libs[i].module,null,installAllowList,installDenyList)) {
                            moduleSet.add(knownFunctionNodes[id].libs[i].module);
                        }
                    }
                }
            }
        }
        var modules = Array.from(moduleSet);
        modules.sort();
        return modules;
    }

    function prepareLibraryConfig(node) {
        $(".node-input-libs-row").show();
        var usedModules = getAllUsedModules();
        var typedModules = usedModules.map(function(l) {
            return {icon:"fa fa-cube", value:l,label:l,hasValue:false}
        })
        typedModules.push({
            value:"_custom_", label:RED._("editor:subflow.licenseOther"), icon:"red/images/typedInput/az.svg"
        })

        var libList = $("#node-input-libs-container").css('min-height','100px').css('min-width','450px').editableList({
            header: $('<div><div data-i18n="node-red:function.require.moduleName"></div><div data-i18n="node-red:function.require.importAs"></div></div>'),
            addItem: function(container,i,opt) {
                var parent = container.parent();
                var row0 = $("<div/>").addClass("node-libs-entry").appendTo(container);
                var fmoduleSpan = $("<span>").appendTo(row0);
                var fmodule = $("<input/>", {
                    class: "node-input-libs-val",
                    placeholder: tr("function.require.module"),
                    type: "text"
                }).css({
                }).appendTo(fmoduleSpan).typedInput({
                    types: typedModules,
                    default: usedModules.indexOf(opt.module) > -1 ? opt.module : "_custom_"
                });
                if (usedModules.indexOf(opt.module) === -1) {
                    fmodule.typedInput('value', opt.module);
                }
                var moduleWarning = $('<span style="position: absolute;right:2px;top:7px; display:inline-block; width: 16px;"><i class="fa fa-warning"></i></span>').appendTo(fmoduleSpan);
                RED.popover.tooltip(moduleWarning.find("i"),function() {
                    var val = fmodule.typedInput("type");
                    if (val === "_custom_") {
                        val = fmodule.val();
                    }
                    var errors = [];

                    if (!RED.utils.checkModuleAllowed(val,null,installAllowList,installDenyList)) {
                        return tr("function.error.moduleNotAllowed", {module: val});
                    } else {
                        return tr("function.error.moduleLoadError", {module: val, error: missingModuleReasons[val]});
                    }
                })

                var fvarSpan = $("<span>").appendTo(row0);

                var fvar = $("<input/>", {
                    class: "node-input-libs-var red-ui-font-code",
                    placeholder: tr("function.require.var"),
                    type: "text"
                }).css({
                }).appendTo(fvarSpan).val(opt.var);
                var vnameWarning = $('<span style="position: absolute; right:2px;top:7px;display:inline-block; width: 16px;"><i class="fa fa-warning"></i></span>').appendTo(fvarSpan);
                RED.popover.tooltip(vnameWarning.find("i"),function() {
                    var val = fvar.val();
                    if (invalidModuleVNames.indexOf(val) !== -1) {
                        return tr("function.error.moduleNameReserved", {name: val})
                    } else {
                        return tr("function.error.moduleNameError", {name: val})
                    }
                })



                fvar.on("change keyup paste", function (e) {
                    var v = $(this).val().trim();
                    if (v === "" || / /.test(v) || invalidModuleVNames.indexOf(v) !== -1) {
                        fvar.addClass("input-error");
                        vnameWarning.addClass("input-error");
                    } else {
                        fvar.removeClass("input-error");
                        vnameWarning.removeClass("input-error");
                    }
                });

                fmodule.on("change keyup paste", function (e) {
                    var val = $(this).typedInput("type");
                    if (val === "_custom_") {
                        val = $(this).val();
                    }
                    var varName = val.trim().replace(/^node:/,"").replace(/^@/,"").replace(/@.*$/,"").replace(/[-_/\.].?/g, function(v) { return v[1]?v[1].toUpperCase():"" });
                    fvar.val(varName);
                    fvar.trigger("change");

                    if (RED.utils.checkModuleAllowed(val,null,installAllowList,installDenyList) && (missingModules.indexOf(val) === -1)) {
                        fmodule.removeClass("input-error");
                        moduleWarning.removeClass("input-error");
                    } else {
                        fmodule.addClass("input-error");
                        moduleWarning.addClass("input-error");
                    }
                });
                if (RED.utils.checkModuleAllowed(opt.module,null,installAllowList,installDenyList) && (missingModules.indexOf(opt.module) === -1)) {
                    fmodule.removeClass("input-error");
                    moduleWarning.removeClass("input-error");
                } else {
                    fmodule.addClass("input-error");
                    moduleWarning.addClass("input-error");
                }
                if (opt.var) {
                    fvar.trigger("change");
                }
            },
            removable: true
        });

        var libs = node.libs || [];
        for (var i=0,l=libs.length;i<l; i++) {
            libList.editableList('addItem',libs[i])
        }

    }

    function getLibsList() {
        var _libs = [];
        if (RED.settings.functionExternalModules !== false) {
            var libs = $("#node-input-libs-container").editableList("items");
            libs.each(function(i) {
                var item = $(this);
                var v = item.find(".node-input-libs-var").val();
                var n = item.find(".node-input-libs-val").typedInput("type");
                if (n === "_custom_") {
                    n = item.find(".node-input-libs-val").val();
                }
                if ((!v || (v === "")) ||
                    (!n || (n === ""))) {
                    return;
                }
                _libs.push({
                    var: v,
                    module: n
                });
            });
        }
        return _libs;
    }

    RED.nodes.registerType('typescript',{
        color: "#61adff",
        category: 'function',
        paletteLabel: 'typescript',
        defaults: {
            name: {value:"_DEFAULT_"},
            func: {value:"\nreturn msg;"},
            outputs: {value:1},
            timeout:{value:RED.settings.functionTimeout || 0},
            useVm: {value:false},
            updated: {value:0},
            declare: {value:"declare const msg: {\n    payload: any;\n    [prop: string]: any;\n};"},
            noerr: {value:0,required:true,
                    validate: function(v, opt) {
                        if (!v) {
                            return true;
                        }
                        return tr("function.error.invalid-js");
                    }},
            initialize: {value:""},
            finalize: {value:""},
            libs: {value: [], validate: function(v, opt) {
                if (!v) { return true; }
                for (var i=0,l=v.length;i<l;i++) {
                    var m = v[i];
                    if (!RED.utils.checkModuleAllowed(m.module,null,installAllowList,installDenyList)) {
                        return tr("function.error.moduleNotAllowed", {module: m.module});
                    }
                    if (m.var === "" || / /.test(m.var)) {
                        return tr("function.error.moduleNameError", {name: m.var});
                    }
                    if (missingModules.indexOf(m.module) > -1) {
                        return tr("function.error.missing-module", {module: m.module});
                    }
                    if (invalidModuleVNames.indexOf(m.var) !== -1){
                        return tr("function.error.moduleNameError", {name: m.var});
                    }
                }
                return true;
            }}
        },
        inputs:1,
        outputs:1,
        icon: "typescript.svg",
        label: getLabel,
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var that = this;
            window.currentNodeInstance = this;

            var tabs = RED.tabs.create({
                id: "func-tabs",
                onchange: function(tab) {
                    $("#func-tabs-content").children().hide();
                    $("#" + tab.id).show();
                    let editor = $("#" + tab.id).find('.monaco-editor').first();
                    if(editor.length) {
                        if(that.editor.nodered && that.editor.type == "monaco") {
                            that.editor.nodered.refreshModuleLibs(getLibsList());
                        }
                        RED.tray.resize();
                        //auto focus editor on tab switch
                        if (that.initEditor.getDomNode() == editor[0]) {
                            that.initEditor.focus();
                        } else if (that.editor.getDomNode() == editor[0]) {
                            that.editor.focus();
                        } else if (that.finalizeEditor.getDomNode() == editor[0]) {
                            that.finalizeEditor.focus();
                        }
                    }
                }
            });
            tabs.addTab({
                id: "func-tab-config",
                iconClass: "fa fa-cog",
                label: tr("function.label.setup")
            });

            tabs.addTab({
                id: "func-tab-init",
                label: tr("function.label.initialize")
            });
            tabs.addTab({
                id: "func-tab-body",
                label: tr("function.label.function")
            });
            tabs.addTab({
                id: "func-tab-finalize",
                label: tr("function.label.finalize")
            });

            tabs.activateTab("func-tab-body");

            $( "#node-input-outputs" ).spinner({
                min: 0,
                max: 500,
                change: function(event, ui) {
                    var value = parseInt(this.value);
                    value = isNaN(value) ? 1 : value;
                    value = Math.max(value, parseInt($(this).attr("aria-valuemin")));
                    value = Math.min(value, parseInt($(this).attr("aria-valuemax")));
                    if (value !== this.value) { $(this).spinner("value", value); }
                }
            });

            // 4294967 is max in node.js timeout.
            $( "#node-input-timeout" ).spinner({
                min: 0,
                max: 4294967,
                change: function(event, ui) {
                    var value = this.value;
                    if(value == ""){
                        value = 0;
                    }
                    else
                    {
                        value = parseInt(value);
                    }
                    value = isNaN(value) ? 1 : value;
                    value = Math.max(value, parseInt($(this).attr("aria-valuemin")));
                    value = Math.min(value, parseInt($(this).attr("aria-valuemax")));
                    if (value !== this.value) { $(this).spinner("value", value); }
                }
            });

            var buildEditor = function(id, stateId, focus, value, defaultValue, extraLibs, offset) {
                var editor = RED.editor.createEditor(configEditor({
                    id: id,
                    mode: 'ace/mode/nrjavascript',
                    value: value || defaultValue || "",
                    stateId: stateId,
                    focus: true,
                    globals: {
                        msg:true,
                        context:true,
                        RED: true,
                        util: true,
                        flow: true,
                        global: true,
                        console: true,
                        Buffer: true,
                        setTimeout: true,
                        clearTimeout: true,
                        setInterval: true,
                        clearInterval: true
                    },
                    extraLibs: extraLibs
                }));
                if (defaultValue && value === "") {
                    editor.moveCursorTo(defaultValue.split("\n").length +offset, 0);
                }
                editor.__stateId = stateId;
                setEditor(editor);
                return editor;
            }
            this.initEditor = buildEditor('node-input-init-editor', this.id + "/" + "initEditor", false, $("#node-input-initialize").val(), tr("function.text.initialize"), undefined, 0);
            this.editor = buildEditor('node-input-func-editor', this.id + "/" + "editor", true, $("#node-input-func").val(), undefined, that.libs || [], undefined, -1);
            this.finalizeEditor = buildEditor('node-input-finalize-editor', this.id + "/" + "finalizeEditor", false, $("#node-input-finalize").val(), tr("function.text.finalize"), undefined, 0);
            this.declareEditor = buildEditor('node-input-declare-editor', this.id + "/" + "declareEditor", false, this.declare || "declare const msg: {\n    payload: any;\n    [prop: string]: any;\n};", undefined, undefined, 0);

            RED.library.create({
                url:"functions", // where to get the data from
                type:"function", // the type of object the library is for
                editor:this.editor, // the field name the main text body goes to
                mode:"ace/mode/nrjavascript",
                fields:[
                    'name', 'outputs', 'timeout',
                    {
                        name: 'initialize',
                        get: function() {
                            return that.initEditor.getValue();
                        },
                        set: function(v) {
                            that.initEditor.setValue(v||tr("function.text.initialize"), -1);
                        }
                    },
                    {
                        name: 'finalize',
                        get: function() {
                            return that.finalizeEditor.getValue();
                        },
                        set: function(v) {
                            that.finalizeEditor.setValue(v||tr("function.text.finalize"), -1);
                        }
                    },
                    {
                        name: 'info',
                        get: function() {
                            return that.infoEditor.getValue();
                        },
                        set: function(v) {
                            that.infoEditor.setValue(v||"", -1);
                        }
                    }
                ],
                ext:"js"
            });

            var expandButtonClickHandler = function(editor) {
                return function (e) {
                    e.preventDefault();
                    var value = editor.getValue();
                    editor.saveView(`inside function-expandButtonClickHandler ${editor.__stateId}`);
                    var extraLibs = that.libs || [];
                    RED.editor.editJavaScript(configEditor({
                        value: value,
                        width: "Infinity",
                        stateId: editor.__stateId,
                        mode: "ace/mode/nrjavascript",
                        focus: true,
                        cancel: function () {
                            setTimeout(function () {
                                editor.focus();
                            }, 250);
                        },
                        complete: function (v, cursor) {
                            editor.setValue(v, -1);
                            setTimeout(function () {
                                editor.restoreView();
                                editor.focus();
                            }, 250);
                        },
                        extraLibs: extraLibs
                    }));
                    setEditor(RED.editor);
                }
            }
            $("#node-init-expand-js").on("click", expandButtonClickHandler(this.initEditor));
            $("#node-function-expand-js").on("click", expandButtonClickHandler(this.editor));
            $("#node-finalize-expand-js").on("click", expandButtonClickHandler(this.finalizeEditor));
            $("#node-declare-expand-js").on("click", expandButtonClickHandler(this.declareEditor));

            RED.popover.tooltip($("#node-init-expand-js"), tr("common.label.expand"));
            RED.popover.tooltip($("#node-function-expand-js"), tr("common.label.expand"));
            RED.popover.tooltip($("#node-finalize-expand-js"), tr("common.label.expand"));
            RED.popover.tooltip($("#node-declare-expand-js"), tr("common.label.expand"));

            if (RED.settings.functionExternalModules !== false) {
                prepareLibraryConfig(that);
                
                // Update TypeScript types when declarations change
                if (this.declareEditor) {
                    this.declareEditor.on('change', function() {
                        const newDeclare = that.declareEditor.getValue();
                        // Update all Monaco editors with new declarations
                        [that.editor, that.initEditor, that.finalizeEditor].forEach(function(editor) {
                            if (editor && editor.type === "monaco") {
                                try {
                                    configMonaco(editor, newDeclare);
                                } catch (error) {
                                    console.warn('[TS] Failed to update declarations:', error);
                                }
                            }
                        });
                    });
                }
                
                // Add default modules button logic
                $("#node-add-default-modules").on("click", function() {
                    var defaultModules = [
                        { var: 'fs', module: 'fs/promises' },
                        { var: 'path', module: 'path' },
                        { var: 'os', module: 'os' },
                        { var: 'crypto', module: 'crypto' },
                        { var: 'process', module: 'process' },
                        { var: 'stream', module: 'stream' },
                        { var: 'events', module: 'events' },
                        { var: 'zlib', module: 'zlib' },
                        { var: 'child_process', module: 'child_process' }
                    ];
                    
                    var libList = $("#node-input-libs-container");
                    defaultModules.forEach(function(module) {
                        libList.editableList('addItem', module);
                    });
                });
            }
        },
        oneditsave: function() {
            var node = this;
            var noerr = 0;
            $("#node-input-noerr").val(0);
            
            // Update timestamp to invalidate compilation cache
            $("#node-input-updated").val(Date.now());

            var disposeEditor = function(editorName,targetName,defaultValue) {
                var editor = node[editorName];
                var annot = editor.getSession().getAnnotations();
                for (var k=0; k < annot.length; k++) {
                    if (annot[k].type === "error") {
                        noerr += annot.length;
                        break;
                    }
                }
                var val = editor.getValue();
                if (defaultValue) {
                    if (val.trim() == defaultValue.trim()) {
                        val = "";
                    }
                }
                editor.destroy();
                delete node[editorName];
                $("#"+targetName).val(val);
            }
            disposeEditor("editor","node-input-func");
            disposeEditor("initEditor","node-input-initialize", tr("function.text.initialize"));
            disposeEditor("finalizeEditor","node-input-finalize", tr("function.text.finalize"));
            disposeEditor("declareEditor","node-input-declare");

            $("#node-input-noerr").val(noerr);
            this.noerr = noerr;
            node.libs = getLibsList();
        },
        oneditcancel: function() {
            var node = this;

            node.editor.destroy();
            delete node.editor;

            node.initEditor.destroy();
            delete node.initEditor;

            node.finalizeEditor.destroy();
            delete node.finalizeEditor;

            node.declareEditor.destroy();
            delete node.declareEditor;
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-text-editor-row)");
            var height = $("#dialog-form").height();
            for (var i=0; i<rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-text-editor-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $("#dialog-form .node-text-editor").css("height",height+"px");

            var height = size.height;
            $("#node-input-init-editor").css("height", (height - 83)+"px");
            $("#node-input-func-editor").css("height", (height - 83)+"px");
            $("#node-input-finalize-editor").css("height", (height - 83)+"px");

            this.initEditor.resize();
            this.editor.resize();
            this.finalizeEditor.resize();
            
            if (this.declareEditor) {
                this.declareEditor.resize();
            }

            $("#node-input-libs-container").css("height", (height - 192)+"px");
        },
        onadd: function() {
            if (this.name === '_DEFAULT_') {
                this.name = ''
                RED.actions.invoke("core:generate-node-names", this, {generateHistory: false})
            }
        }
    });
})();
</script>
